<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>SnakeGame by jaimefg1888</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg:#0d0d0d; --surface:#111116; --border:#1e1e2e;
    --accent:#00ff88; --danger:#ff3355; --yellow:#ffd700;
    --text:#aaaacc; --bright:#eeeeff;
    --pixel:'Press Start 2P',monospace; --ui:'Rajdhani',sans-serif;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{
    background:var(--bg); color:var(--text); font-family:var(--ui);
    min-height:100vh; display:flex; flex-direction:column;
    align-items:center; justify-content:flex-start;
    padding:12px 12px 28px; user-select:none; -webkit-user-select:none; overflow-x:hidden;
    overflow:hidden;
  }
  body::before{
    content:''; position:fixed; inset:0;
    background:radial-gradient(ellipse 80% 50% at 50% 0%,rgba(0,255,136,.04),transparent 60%);
    pointer-events:none;
  }
  .wrapper{width:100%;max-width:500px;display:flex;flex-direction:column;align-items:center;gap:10px;}

  /* HEADER */
  .header{
    width:100%; display:grid; grid-template-columns:1fr auto 1fr;
    align-items:center; padding-bottom:10px; border-bottom:1px solid var(--border); gap:8px;
  }
  .header-title{
    font-family:var(--pixel); font-size:clamp(.38rem,2vw,.52rem);
    color:var(--accent); text-shadow:0 0 10px rgba(0,255,136,.5); line-height:1.7;
  }
  .header-title span{display:block;color:#444;font-size:.85em;}
  .header-pause{
    background:none; border:1px solid var(--border); color:var(--text);
    width:34px; height:34px; cursor:pointer; font-size:.95rem;
    display:flex; align-items:center; justify-content:center;
    transition:all .15s; border-radius:3px;
  }
  .header-pause:hover{border-color:var(--accent);color:var(--accent);}
  .header-pause.hidden{visibility:hidden;pointer-events:none;}
  .header-stats{display:flex;justify-content:flex-end;}
  .stat-row{display:flex;gap:14px;}
  .stat{text-align:right;}
  .stat-label{font-family:var(--pixel);font-size:.33rem;color:#444;display:block;margin-bottom:2px;letter-spacing:.1em;}
  .stat-value{font-family:var(--pixel);font-size:clamp(.5rem,2vw,.65rem);color:var(--bright);}

  /* CANVAS */
  .canvas-wrap{position:relative;width:100%;aspect-ratio:1;max-width:480px;background:var(--surface);border:2px solid var(--border);overflow:hidden;}
  .canvas-wrap::before{
    content:'';position:absolute;inset:0;
    background-image:linear-gradient(rgba(0,255,136,.07) 1px,transparent 1px),linear-gradient(90deg,rgba(0,255,136,.07) 1px,transparent 1px);
    background-size:calc(100%/20) calc(100%/20);pointer-events:none;z-index:1;
  }
  canvas{display:block;width:100%;height:100%;image-rendering:pixelated;touch-action:none;}

  /* OVERLAYS */
  .overlay{
    position:absolute;inset:0;display:flex;flex-direction:column;
    align-items:center;justify-content:center;
    background:rgba(8,8,14,.95);z-index:10;gap:13px;
    backdrop-filter:blur(3px);padding:20px;overflow-y:auto;
  }
  .overlay.hidden{display:none;}
  @keyframes fadeIn{from{opacity:0;transform:scale(.97)}to{opacity:1;transform:scale(1)}}
  .overlay:not(.hidden){animation:fadeIn .2s ease;}

  .ov-title{font-family:var(--pixel);font-size:clamp(.7rem,3.5vw,1.1rem);color:var(--accent);text-shadow:0 0 18px rgba(0,255,136,.6);text-align:center;line-height:1.8;}
  .ov-title.danger{color:var(--danger);text-shadow:0 0 18px rgba(255,51,85,.6);}
  .ov-title.yellow{color:var(--yellow);text-shadow:0 0 18px rgba(255,215,0,.5);}

  /* SPEED BOXES */
  .speed-selector{display:flex;flex-direction:column;align-items:center;gap:7px;width:100%;}
  .speed-label{font-family:var(--pixel);font-size:.37rem;color:#555;letter-spacing:.1em;}
  .speed-boxes{display:flex;gap:5px;}
  .speed-box{
    width:clamp(18px,4.2vw,25px);height:clamp(18px,4.2vw,25px);
    background:var(--border);border:none;cursor:pointer;transition:background .15s;border-radius:2px;
  }
  .speed-box.active{background:var(--accent);}
  .speed-box:hover:not(.active){background:#2a2a3a;}

  /* WALLS + OPTIONS */
  .option-row{display:flex;align-items:center;gap:12px;}
  .opt-label{font-family:var(--pixel);font-size:.37rem;color:#555;letter-spacing:.1em;}
  .two-btn{display:flex;border:1px solid var(--border);overflow:hidden;border-radius:3px;}
  .two-btn button{
    font-family:var(--pixel);font-size:.36rem;padding:6px 13px;
    background:none;border:none;color:#555;cursor:pointer;transition:all .15s;letter-spacing:.06em;
  }
  .two-btn button.on{background:var(--accent);color:#000;}

  /* LANG */
  .lang-row{display:flex;gap:8px;}
  .lang-btn{
    font-family:var(--pixel);font-size:.36rem;padding:5px 11px;
    border:1px solid var(--border);background:none;color:#555;
    cursor:pointer;transition:all .15s;border-radius:3px;letter-spacing:.06em;
  }
  .lang-btn.active{border-color:var(--accent);color:var(--accent);}

  /* BUTTONS */
  .btn{
    font-family:var(--pixel);font-size:clamp(.37rem,1.8vw,.53rem);
    letter-spacing:.05em;padding:11px 20px;
    border:2px solid var(--accent);background:transparent;color:var(--accent);
    cursor:pointer;transition:all .15s;min-width:148px;text-align:center;border-radius:2px;
  }
  .btn:hover{background:var(--accent);color:#000;}
  .btn.danger{border-color:var(--danger);color:var(--danger);}
  .btn.danger:hover{background:var(--danger);color:#fff;}
  .btn.yellow{border-color:var(--yellow);color:var(--yellow);}
  .btn.yellow:hover{background:var(--yellow);color:#000;}
  .btn.sm{font-size:.34rem;padding:8px 14px;min-width:110px;}

  /* SCORES */
  .final-score{font-family:var(--pixel);font-size:clamp(.42rem,2vw,.6rem);color:var(--bright);text-align:center;line-height:2.2;}
  .hiscore-line{font-family:var(--pixel);font-size:.36rem;color:#333;letter-spacing:.1em;}
  .hiscore-line span{color:#555;}

  /* NAME INPUT */
  .name-wrap{display:flex;flex-direction:column;align-items:center;gap:10px;width:100%;}
  .name-wrap p{font-family:var(--pixel);font-size:.4rem;color:var(--yellow);text-align:center;line-height:2.2;}
  .name-input{
    font-family:var(--pixel);font-size:.52rem;padding:10px 16px;
    background:#111;border:2px solid var(--accent);color:var(--accent);
    width:100%;max-width:240px;text-align:center;outline:none;
    border-radius:2px;letter-spacing:.12em;
  }

  /* RANKING */
  .ranking-wrap{width:100%;max-width:420px;}
  .ranking-title{font-family:var(--pixel);font-size:.4rem;color:var(--yellow);letter-spacing:.1em;text-align:center;margin-bottom:10px;}
  .ranking-table{width:100%;border-collapse:collapse;}
  .ranking-table th{font-family:var(--pixel);font-size:.3rem;color:#444;letter-spacing:.08em;padding:5px 6px;border-bottom:1px solid var(--border);text-align:left;}
  .ranking-table td{font-family:var(--pixel);font-size:.35rem;color:var(--text);padding:6px 6px;border-bottom:1px solid #161620;}
  .ranking-table tr.gold td{color:var(--yellow);}
  .ranking-table tr.silver td{color:#bbb;}
  .ranking-table tr.bronze td{color:#cd7f32;}
  .rank-num{color:#444;min-width:22px;}
  .no-scores{font-family:var(--pixel);font-size:.35rem;color:#333;text-align:center;padding:18px;}

  .level-tabs{display:flex;flex-wrap:wrap;gap:4px;justify-content:center;margin-bottom:10px;}
  .level-tab{
    font-family:var(--pixel);font-size:.3rem;padding:4px 8px;
    border:1px solid var(--border);background:none;color:#444;
    cursor:pointer;transition:all .15s;letter-spacing:.05em;border-radius:2px;
  }
  .level-tab.active{border-color:var(--yellow);color:var(--yellow);}

  /* D-PAD */
  .dpad{
    display:none;
    grid-template-areas:". up ." "left . right" ". down .";
    grid-template-columns:repeat(3,52px);grid-template-rows:repeat(3,52px);
    gap:5px;margin-top:6px;
  }
  @media(pointer:coarse){.dpad{display:grid;}}
  .dpad-btn{
    background:var(--surface);border:1px solid var(--border);color:var(--text);
    font-size:1.15rem;cursor:pointer;display:flex;align-items:center;justify-content:center;
    border-radius:6px;transition:all .1s;-webkit-tap-highlight-color:transparent;touch-action:none;
  }
  .dpad-btn:active{background:#1e1e2e;color:var(--accent);border-color:var(--accent);}
  .dpad-up{grid-area:up;} .dpad-left{grid-area:left;} .dpad-right{grid-area:right;} .dpad-down{grid-area:down;}
</style>
</head>
<body>
<div class="wrapper">

  <!-- HEADER -->
  <div class="header">
    <div class="header-title">
      ğŸ SnakeGame
      <span>by jaimefg1888</span>
    </div>
    <button class="header-pause hidden" id="headerPause">â¸</button>
    <div class="header-stats">
      <div class="stat-row">
        <div class="stat">
          <span class="stat-label" data-i18n="score">PUNTOS</span>
          <span class="stat-value" id="scoreDisplay">0</span>
        </div>
        <div class="stat">
          <span class="stat-label" data-i18n="time">TIEMPO</span>
          <span class="stat-value" id="timeDisplay">0:00</span>
        </div>
      </div>
    </div>
  </div>

  <!-- CANVAS + OVERLAYS -->
  <div class="canvas-wrap">
    <canvas id="gameCanvas"></canvas>

    <!-- START -->
    <div class="overlay" id="startScreen">
      <div class="lang-row">
        <button class="lang-btn active" id="langES">ğŸ‡ªğŸ‡¸ ES</button>
        <button class="lang-btn" id="langEN">ğŸ‡¬ğŸ‡§ EN</button>
      </div>

      <div class="ov-title">ğŸ SNAKE</div>

      <div class="speed-selector">
        <span class="speed-label" data-i18n="speed_lbl">VELOCIDAD</span>
        <div class="speed-boxes" id="speedBoxes"></div>
      </div>

      <div class="option-row">
        <span class="opt-label" data-i18n="walls_lbl">BORDES</span>
        <div class="two-btn">
          <button id="wallsOn" class="on" data-i18n="yes">SÃ</button>
          <button id="wallsOff" data-i18n="no">NO</button>
        </div>
      </div>

      <button class="btn" id="startBtn" data-i18n="start">â–¶ COMENZAR</button>
      <button class="btn yellow sm" id="rankingBtn" data-i18n="ranking_btn">ğŸ† RANKING</button>
    </div>

    <!-- PAUSE -->
    <div class="overlay hidden" id="pauseScreen">
      <div class="ov-title yellow" data-i18n="paused">â¸ PAUSA</div>
      <div class="final-score" id="pauseInfo"></div>
      <button class="btn" id="resumeBtn" data-i18n="resume">â–¶ CONTINUAR</button>
      <button class="btn sm" id="menuFromPauseBtn" data-i18n="main_menu">MENÃš PRINCIPAL</button>
    </div>

    <!-- NAME INPUT -->
    <div class="overlay hidden" id="nameScreen">
      <div class="ov-title yellow" data-i18n="top10_title">ğŸ† TOP 10</div>
      <div class="name-wrap">
        <p id="namePromptText" data-i18n="name_prompt">Â¡Entraste al ranking!<br>Introduce tu nombre:</p>
        <input class="name-input" id="nameInput" maxlength="12" placeholder="NOMBRE" autocomplete="off" spellcheck="false"/>
        <button class="btn" id="saveNameBtn" data-i18n="save">ğŸ’¾ GUARDAR</button>
      </div>
    </div>

    <!-- GAME OVER -->
    <div class="overlay hidden" id="gameOverScreen">
      <div class="ov-title danger" data-i18n="game_over">GAME OVER</div>
      <div class="final-score" id="finalScore"></div>
      <button class="btn" id="restartBtn" data-i18n="play_again">â–¶ JUGAR DE NUEVO</button>
      <button class="btn sm" id="menuFromGameOverBtn" data-i18n="main_menu">MENÃš PRINCIPAL</button>
      <button class="btn yellow sm" id="rankingFromGameOverBtn" data-i18n="ranking_btn">ğŸ† RANKING</button>
    </div>

    <!-- RANKING -->
    <div class="overlay hidden" id="rankingScreen">
      <div class="ov-title yellow" data-i18n="ranking_title">ğŸ† RANKING</div>
      <div class="level-tabs" id="levelTabs"></div>
      <div class="ranking-wrap" id="rankingContent"></div>
      <button class="btn sm" id="closeRankingBtn" data-i18n="close">âœ• CERRAR</button>
    </div>

  </div>

  <!-- D-PAD -->
  <div class="dpad">
    <button class="dpad-btn dpad-up" data-dir="UP">â–²</button>
    <button class="dpad-btn dpad-left" data-dir="LEFT">â—€</button>
    <button class="dpad-btn dpad-right" data-dir="RIGHT">â–¶</button>
    <button class="dpad-btn dpad-down" data-dir="DOWN">â–¼</button>
  </div>

</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// I18N
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const T = {
  es:{
    score:'PUNTOS', time:'TIEMPO', speed_lbl:'VELOCIDAD', walls_lbl:'BORDES',
    yes:'SÃ', no:'NO', start:'â–¶ COMENZAR', ranking_btn:'ğŸ† RANKING',
    ranking_title:'ğŸ† RANKING', paused:'â¸ PAUSA', resume:'â–¶ CONTINUAR',
    main_menu:'MENÃš PRINCIPAL', game_over:'GAME OVER', play_again:'â–¶ JUGAR DE NUEVO',
    close:'âœ• CERRAR', top10_title:'ğŸ† TOP 10',
    name_prompt:'Â¡Entraste al ranking!\nIntroduce tu nombre:', save:'ğŸ’¾ GUARDAR',
    level:'NIVEL', player:'JUGADOR', score_col:'PTS', time_col:'TIEMPO',
    date_col:'FECHA', no_scores:'Sin puntuaciones aÃºn.',
    best:'MEJOR:', score_label:'PUNTOS', time_label:'TIEMPO',
    name_placeholder:'NOMBRE'
  },
  en:{
    score:'SCORE', time:'TIME', speed_lbl:'SPEED', walls_lbl:'WALLS',
    yes:'YES', no:'NO', start:'â–¶ START', ranking_btn:'ğŸ† RANKING',
    ranking_title:'ğŸ† RANKING', paused:'â¸ PAUSED', resume:'â–¶ RESUME',
    main_menu:'MAIN MENU', game_over:'GAME OVER', play_again:'â–¶ PLAY AGAIN',
    close:'âœ• CLOSE', top10_title:'ğŸ† TOP 10',
    name_prompt:"You made the ranking!\nEnter your name:", save:'ğŸ’¾ SAVE',
    level:'LEVEL', player:'PLAYER', score_col:'PTS', time_col:'TIME',
    date_col:'DATE', no_scores:'No scores yet.',
    best:'BEST:', score_label:'SCORE', time_label:'TIME',
    name_placeholder:'NAME'
  }
};
let lang = 'es';
const t = k => T[lang][k] || k;

function applyLang() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const v = t(el.dataset.i18n);
    if (el.tagName === 'INPUT') el.placeholder = v;
    else el.textContent = v;
  });
  document.getElementById('nameInput').placeholder = t('name_placeholder');
  document.getElementById('langES').classList.toggle('active', lang==='es');
  document.getElementById('langEN').classList.toggle('active', lang==='en');
  updateSpeedBoxes();
  document.getElementById('wallsOn').textContent = t('yes');
  document.getElementById('wallsOff').textContent = t('no');
  if (rankingOpen) renderRanking(rankingLevel);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CANVAS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const GRID = 20;
let CELL;
function resize() {
  const s = canvas.parentElement.clientWidth;
  canvas.width = canvas.height = s;
  CELL = Math.floor(s / GRID);
}
resize();
window.addEventListener('resize', () => { resize(); if (!running) drawGame(); });

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let snake, dir, nextDir, food;
let score=0, timer=0, timerInterval, startTime;
let running=false, paused=false, gameOver=false;
let walls=true, speed=5;
let pendingScore=0, pendingTime=0, pendingSpeed=5;
let rankingOpen=false, rankingLevel=5, rankingFromMenu=false;

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RANKING DATA (localStorage, JSON)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const rkKey = lvl => `snakeRanking_lvl${lvl}`;
const getRanking = lvl => { try { return JSON.parse(localStorage.getItem(rkKey(lvl)))||[]; } catch { return []; } };
const saveRanking = (lvl,d) => localStorage.setItem(rkKey(lvl), JSON.stringify(d));

function isTop10(lvl, sc) {
  const r = getRanking(lvl);
  return r.length < 10 || sc > (r[9]?.score ?? -1);
}
function addScore(lvl, name, sc, tm) {
  const r = getRanking(lvl);
  r.push({ name: (name.trim().toUpperCase()||'???').slice(0,12), score:sc, time:tm, date:new Date().toLocaleDateString() });
  r.sort((a,b) => b.score-a.score || a.time-b.time);
  r.splice(10);
  saveRanking(lvl, r);
}
function calcHiScore() {
  let best=0;
  for(let i=1;i<=10;i++){const r=getRanking(i);if(r[0])best=Math.max(best,r[0].score);}
  return best;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SPEED BOXES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildSpeedBoxes() {
  const c = document.getElementById('speedBoxes');
  c.innerHTML='';
  for(let i=1;i<=10;i++){
    const b=document.createElement('button');
    b.className='speed-box'+(i===speed?' active':'');
    b.addEventListener('click',()=>{ speed=i; updateSpeedBoxes(); });
    c.appendChild(b);
  }
}
function updateSpeedBoxes(){
  document.querySelectorAll('.speed-box').forEach((b,i)=>b.classList.toggle('active',i+1===speed));
}
buildSpeedBoxes();

// Walls
document.getElementById('wallsOn').addEventListener('click',()=>{
  walls=true;
  document.getElementById('wallsOn').classList.add('on');
  document.getElementById('wallsOff').classList.remove('on');
});
document.getElementById('wallsOff').addEventListener('click',()=>{
  walls=false;
  document.getElementById('wallsOff').classList.add('on');
  document.getElementById('wallsOn').classList.remove('on');
});

// Lang
document.getElementById('langES').addEventListener('click',()=>{lang='es';applyLang();});
document.getElementById('langEN').addEventListener('click',()=>{lang='en';applyLang();});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GAME
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function speedMs(s){ return Math.round(540/(s*.88+.4)); }

function initGame(){
  const m=Math.floor(GRID/2);
  snake=[{x:m,y:m},{x:m-1,y:m},{x:m-2,y:m}];
  dir={x:1,y:0}; nextDir={x:1,y:0};
  score=0; timer=0; gameOver=false; paused=false;
  document.getElementById('scoreDisplay').textContent='0';
  document.getElementById('timeDisplay').textContent='0:00';
  spawnFood(); startTimer();
}

function spawnFood(){
  let p;
  do{ p={x:Math.floor(Math.random()*GRID),y:Math.floor(Math.random()*GRID)}; }
  while(snake.some(s=>s.x===p.x&&s.y===p.y));
  food=p;
}

function startTimer(){
  clearInterval(timerInterval);
  startTime=Date.now();
  timerInterval=setInterval(()=>{
    if(!paused&&running&&!gameOver){
      timer=Math.floor((Date.now()-startTime)/1000);
      const m=Math.floor(timer/60),s=timer%60;
      document.getElementById('timeDisplay').textContent=`${m}:${s.toString().padStart(2,'0')}`;
    }
  },500);
}

let lastTick=0, af;
function gameLoop(ts){
  if(!running||paused||gameOver)return;
  af=requestAnimationFrame(gameLoop);
  if(ts-lastTick<speedMs(speed))return;
  lastTick=ts; tick();
}
function tick(){
  dir={...nextDir};
  const h={x:snake[0].x+dir.x, y:snake[0].y+dir.y};
  if(walls){
    if(h.x<0||h.x>=GRID||h.y<0||h.y>=GRID){endGame();return;}
  } else {
    h.x=(h.x+GRID)%GRID; h.y=(h.y+GRID)%GRID;
  }
  if(snake.some(s=>s.x===h.x&&s.y===h.y)){endGame();return;}
  snake.unshift(h);
  if(h.x===food.x&&h.y===food.y){
    score++;
    document.getElementById('scoreDisplay').textContent=score;
    spawnFood();
  } else { snake.pop(); }
  drawGame();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DRAW
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawGame(){
  const w=canvas.width, h=canvas.height;
  ctx.fillStyle='#0d0d0d'; ctx.fillRect(0,0,w,h);

  // Food
  const fx=food.x*CELL+CELL/2, fy=food.y*CELL+CELL/2, fr=CELL*.38;
  const fg=ctx.createRadialGradient(fx,fy,0,fx,fy,fr*2.8);
  fg.addColorStop(0,'rgba(255,51,85,.3)'); fg.addColorStop(1,'transparent');
  ctx.fillStyle=fg; ctx.beginPath(); ctx.arc(fx,fy,fr*2.8,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='#ff3355'; ctx.beginPath(); ctx.arc(fx,fy,fr,0,Math.PI*2); ctx.fill();
  ctx.fillStyle='rgba(255,160,160,.55)'; ctx.beginPath(); ctx.arc(fx-fr*.3,fy-fr*.3,fr*.3,0,Math.PI*2); ctx.fill();

  // Snake
  snake.forEach((seg,i)=>{
    const x=seg.x*CELL, y=seg.y*CELL, pad=1.5, isHead=i===0;
    if(isHead){
      const hg=ctx.createRadialGradient(x+CELL/2,y+CELL/2,0,x+CELL/2,y+CELL/2,CELL*1.2);
      hg.addColorStop(0,'rgba(0,255,136,.2)'); hg.addColorStop(1,'transparent');
      ctx.fillStyle=hg; ctx.fillRect(x-CELL*.5,y-CELL*.5,CELL*2,CELL*2);
      ctx.fillStyle='#00ff88';
    } else {
      const a=Math.max(.22,1-i/snake.length*.78);
      ctx.fillStyle=`rgba(0,${Math.round(140+115*a)},${Math.round(70*a)},${a})`;
    }
    rr(ctx,x+pad,y+pad,CELL-pad*2,CELL-pad*2,isHead?4:2); ctx.fill();

    if(isHead){
      const es=Math.max(1.5,CELL*.11);
      ctx.fillStyle='#001a0d';
      let e1x,e1y,e2x,e2y;
      if(dir.x!==0){ e1x=x+CELL*.5+dir.x*CELL*.22; e1y=y+CELL*.3; e2x=e1x; e2y=y+CELL*.7; }
      else { e1x=x+CELL*.3; e1y=y+CELL*.5+dir.y*CELL*.22; e2x=x+CELL*.7; e2y=e1y; }
      ctx.beginPath(); ctx.arc(e1x,e1y,es,0,Math.PI*2); ctx.arc(e2x,e2y,es,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='rgba(255,255,255,.55)';
      ctx.beginPath(); ctx.arc(e1x-es*.35,e1y-es*.35,es*.38,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(e2x-es*.35,e2y-es*.35,es*.38,0,Math.PI*2); ctx.fill();
    }
  });
}
function rr(c,x,y,w,h,r){
  c.beginPath();
  c.moveTo(x+r,y);c.lineTo(x+w-r,y);c.arcTo(x+w,y,x+w,y+r,r);
  c.lineTo(x+w,y+h-r);c.arcTo(x+w,y+h,x+w-r,y+h,r);
  c.lineTo(x+r,y+h);c.arcTo(x,y+h,x,y+h-r,r);
  c.lineTo(x,y+r);c.arcTo(x,y,x+r,y,r);c.closePath();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SCREENS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SCREENS=['startScreen','pauseScreen','nameScreen','gameOverScreen','rankingScreen'];
function showOnly(id){
  SCREENS.forEach(s=>document.getElementById(s).classList.toggle('hidden',s!==id));
  if(!id) SCREENS.forEach(s=>document.getElementById(s).classList.add('hidden'));
}

function startGame(){
  showOnly(null);
  running=true;
  document.getElementById('headerPause').classList.remove('hidden');
  initGame(); drawGame(); lastTick=0;
  requestAnimationFrame(gameLoop);
}

function endGame(){
  running=false; gameOver=true;
  clearInterval(timerInterval); cancelAnimationFrame(af);
  document.getElementById('headerPause').classList.add('hidden');
  pendingScore=score; pendingTime=timer; pendingSpeed=speed;
  const m=Math.floor(timer/60),s=timer%60;
  document.getElementById('finalScore').textContent=
    `${t('score_label')}: ${score}   ${t('time_label')}: ${m}:${s.toString().padStart(2,'0')}`;
  if(isTop10(speed,score)){
    showOnly('nameScreen');
    setTimeout(()=>document.getElementById('nameInput').focus(),120);
  } else {
    showOnly('gameOverScreen');
  }
}

function togglePause(){
  if(!running||gameOver)return;
  paused=!paused;
  if(paused){
    cancelAnimationFrame(af);
    const m=Math.floor(timer/60),s=timer%60;
    document.getElementById('pauseInfo').textContent=
      `${t('score_label')}: ${score}   ${t('time_label')}: ${m}:${s.toString().padStart(2,'0')}`;
    showOnly('pauseScreen');
  } else {
    showOnly(null);
    lastTick=0; requestAnimationFrame(gameLoop);
  }
}

function saveScore(){
  const name=document.getElementById('nameInput').value||'???';
  document.getElementById('nameInput').value='';
  addScore(pendingSpeed,name,pendingScore,pendingTime);
  showOnly('gameOverScreen');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RANKING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openRanking(lvl, fromMenu=false){
  rankingOpen=true; rankingLevel=lvl||speed; rankingFromMenu=fromMenu;
  buildLevelTabs(); renderRanking(rankingLevel);
  showOnly('rankingScreen');
}
function buildLevelTabs(){
  const c=document.getElementById('levelTabs'); c.innerHTML='';
  for(let i=1;i<=10;i++){
    const b=document.createElement('button');
    b.className='level-tab'+(i===rankingLevel?' active':'');
    b.textContent=`${t('level')} ${i}`;
    b.addEventListener('click',()=>{
      rankingLevel=i;
      document.querySelectorAll('.level-tab').forEach((x,j)=>x.classList.toggle('active',j+1===i));
      renderRanking(i);
    });
    c.appendChild(b);
  }
}
function fmtTime(s){const m=Math.floor(s/60);return `${m}:${(s%60).toString().padStart(2,'0')}`;}
function renderRanking(lvl){
  const data=getRanking(lvl);
  const wrap=document.getElementById('rankingContent');
  let html=`<div class="ranking-title">${t('level')} ${lvl}</div>`;
  if(!data.length){
    html+=`<div class="no-scores">${t('no_scores')}</div>`;
  } else {
    html+=`<table class="ranking-table"><tr>
      <th>#</th><th>${t('player')}</th><th>${t('score_col')}</th><th>${t('date_col')}</th>
    </tr>`;
    data.forEach((e,i)=>{
      const cls=i===0?'gold':i===1?'silver':i===2?'bronze':'';
      const medal=i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':i+1;
      html+=`<tr class="${cls}"><td class="rank-num">${medal}</td><td>${e.name}</td><td>${e.score}</td><td>${e.date||'-'}</td></tr>`;
    });
    html+='</table>';
  }
  wrap.innerHTML=html;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BUTTON WIRING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('startBtn').addEventListener('click',startGame);
document.getElementById('headerPause').addEventListener('click',togglePause);
document.getElementById('resumeBtn').addEventListener('click',togglePause);
document.getElementById('menuFromPauseBtn').addEventListener('click',()=>{
  running=false;paused=false;gameOver=true;
  clearInterval(timerInterval);cancelAnimationFrame(af);
  document.getElementById('headerPause').classList.add('hidden');
  showOnly('startScreen');
});
document.getElementById('restartBtn').addEventListener('click',startGame);
document.getElementById('menuFromGameOverBtn').addEventListener('click',()=>showOnly('startScreen'));
document.getElementById('saveNameBtn').addEventListener('click',saveScore);
document.getElementById('nameInput').addEventListener('keydown',e=>{if(e.key==='Enter')saveScore();});
document.getElementById('rankingBtn').addEventListener('click',()=>openRanking(speed, true));
document.getElementById('rankingFromGameOverBtn').addEventListener('click',()=>openRanking(pendingSpeed, false));
document.getElementById('closeRankingBtn').addEventListener('click',()=>{
  rankingOpen=false;
  if(rankingFromMenu) showOnly('startScreen');
  else if(gameOver) showOnly('gameOverScreen');
  else showOnly(null);
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INPUT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const KMAP={
  ArrowUp:{x:0,y:-1},w:{x:0,y:-1},W:{x:0,y:-1},
  ArrowDown:{x:0,y:1},s:{x:0,y:1},S:{x:0,y:1},
  ArrowLeft:{x:-1,y:0},a:{x:-1,y:0},A:{x:-1,y:0},
  ArrowRight:{x:1,y:0},d:{x:1,y:0},D:{x:1,y:0},
};
document.addEventListener('keydown',e=>{
  if(e.key===' '){e.preventDefault();togglePause();return;}
  const d=KMAP[e.key];
  if(d&&running&&!paused&&!gameOver){
    if(d.x!==-(dir.x)||d.y!==-(dir.y)) nextDir=d;
    e.preventDefault();
  }
});

const DMAP={UP:{x:0,y:-1},DOWN:{x:0,y:1},LEFT:{x:-1,y:0},RIGHT:{x:1,y:0}};
document.querySelectorAll('.dpad-btn').forEach(b=>{
  b.addEventListener('touchstart',e=>e.preventDefault(),{passive:false});
  b.addEventListener('click',()=>{
    const d=DMAP[b.dataset.dir];
    if(d&&running&&!paused&&!gameOver)
      if(d.x!==-(dir.x)||d.y!==-(dir.y)) nextDir=d;
  });
});

let tx=0,ty=0;
// Prevent scroll when touching the game area
document.body.addEventListener('touchmove',e=>{ if(running&&!paused) e.preventDefault(); },{passive:false});
document.addEventListener('touchstart',e=>{
  tx=e.touches[0].clientX; ty=e.touches[0].clientY;
},{passive:true});
document.addEventListener('touchend',e=>{
  const dx=e.changedTouches[0].clientX-tx, dy=e.changedTouches[0].clientY-ty;
  if(Math.abs(dx)<15&&Math.abs(dy)<15)return;
  let d=Math.abs(dx)>Math.abs(dy)?(dx>0?{x:1,y:0}:{x:-1,y:0}):(dy>0?{x:0,y:1}:{x:0,y:-1});
  if(running&&!paused&&!gameOver) if(d.x!==-(dir.x)||d.y!==-(dir.y)) nextDir=d;
},{passive:true});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
resize(); drawGame(); applyLang();
</script>
</body>
</html>
