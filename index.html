<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>SnakeGame by jaimefg1888</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Rajdhani:wght@400;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    /* â”€â”€ Variables â”€â”€ */
    :root {
      --bg:       #0d0d0d;
      --surface:  #111116;
      --border:   #1e1e2e;
      --accent:   #00ff88;
      --danger:   #ff3355;
      --yellow:   #ffd700;
      --text:     #aaaacc;
      --bright:   #eeeeff;
      --font-pixel: 'Press Start 2P', monospace;
      --font-ui:    'Rajdhani', sans-serif;
    }

    /* â”€â”€ Reset â”€â”€ */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* â”€â”€ Base â”€â”€ */
    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-ui);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 12px 12px 28px;
      overflow: hidden;
      user-select: none;
      -webkit-user-select: none;
    }

    /* Sutil degradado verde en la parte superior */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background: radial-gradient(ellipse 80% 50% at 50% 0%, rgba(0, 255, 136, 0.04), transparent 60%);
      pointer-events: none;
    }

    .wrapper {
      width: 100%;
      max-width: 500px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    /* â”€â”€ Header â”€â”€ */
    .header {
      width: 100%;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 8px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .header-title {
      font-family: var(--font-pixel);
      font-size: clamp(0.38rem, 2vw, 0.52rem);
      color: var(--accent);
      text-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
      line-height: 1.7;
    }

    .header-title span {
      display: block;
      color: #444;
      font-size: 0.85em;
    }

    .btn-pause {
      background: none;
      border: 1px solid var(--border);
      color: var(--text);
      width: 34px;
      height: 34px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }

    .btn-pause:hover { border-color: var(--accent); color: var(--accent); }
    .btn-pause.hidden { visibility: hidden; pointer-events: none; }

    .header-stats {
      display: flex;
      justify-content: flex-end;
    }

    .stat-row {
      display: flex;
      gap: 14px;
    }

    .stat {
      text-align: right;
    }

    .stat-label {
      display: block;
      font-family: var(--font-pixel);
      font-size: 0.33rem;
      color: #444;
      letter-spacing: 0.1em;
      margin-bottom: 2px;
    }

    .stat-value {
      font-family: var(--font-pixel);
      font-size: clamp(0.5rem, 2vw, 0.65rem);
      color: var(--bright);
    }

    /* â”€â”€ Tablero â”€â”€ */
    .canvas-wrap {
      position: relative;
      width: 100%;
      aspect-ratio: 1;
      max-width: 480px;
      background: var(--surface);
      border: 2px solid var(--border);
      overflow: hidden;
    }

    /* CuadrÃ­cula visible */
    .canvas-wrap::before {
      content: '';
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgba(0, 255, 136, 0.07) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 136, 0.07) 1px, transparent 1px);
      background-size: calc(100% / 20) calc(100% / 20);
      pointer-events: none;
      z-index: 1;
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
      image-rendering: pixelated;
      touch-action: none;
    }

    /* â”€â”€ Overlays (pantallas) â”€â”€ */
    .overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 13px;
      padding: 20px;
      background: rgba(8, 8, 14, 0.95);
      backdrop-filter: blur(3px);
      overflow-y: auto;
      z-index: 10;
    }

    .overlay.hidden { display: none; }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.97); }
      to   { opacity: 1; transform: scale(1); }
    }

    .overlay:not(.hidden) { animation: fadeIn 0.2s ease; }

    .ov-title {
      font-family: var(--font-pixel);
      font-size: clamp(0.7rem, 3.5vw, 1.1rem);
      color: var(--accent);
      text-shadow: 0 0 18px rgba(0, 255, 136, 0.6);
      text-align: center;
      line-height: 1.8;
    }

    .ov-title.danger { color: var(--danger); text-shadow: 0 0 18px rgba(255, 51, 85, 0.6); }
    .ov-title.yellow { color: var(--yellow); text-shadow: 0 0 18px rgba(255, 215, 0, 0.5); }

    /* â”€â”€ Selector de idioma â”€â”€ */
    .lang-row {
      display: flex;
      gap: 8px;
    }

    .lang-btn {
      font-family: var(--font-pixel);
      font-size: 0.36rem;
      padding: 5px 11px;
      border: 1px solid var(--border);
      background: none;
      color: #555;
      border-radius: 3px;
      cursor: pointer;
      letter-spacing: 0.06em;
      transition: all 0.15s;
    }

    .lang-btn.active { border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ Selector de velocidad (10 cuadros) â”€â”€ */
    .speed-selector {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 7px;
      width: 100%;
    }

    .speed-label {
      font-family: var(--font-pixel);
      font-size: 0.37rem;
      color: #555;
      letter-spacing: 0.1em;
    }

    .speed-boxes {
      display: flex;
      gap: 5px;
    }

    .speed-box {
      width: clamp(18px, 4.2vw, 25px);
      height: clamp(18px, 4.2vw, 25px);
      background: var(--border);
      border: none;
      border-radius: 2px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .speed-box.active          { background: var(--accent); }
    .speed-box:hover:not(.active) { background: #2a2a3a; }

    /* â”€â”€ Toggle bordes â”€â”€ */
    .option-row {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .opt-label {
      font-family: var(--font-pixel);
      font-size: 0.37rem;
      color: #555;
      letter-spacing: 0.1em;
    }

    .two-btn {
      display: flex;
      border: 1px solid var(--border);
      border-radius: 3px;
      overflow: hidden;
    }

    .two-btn button {
      font-family: var(--font-pixel);
      font-size: 0.36rem;
      padding: 6px 13px;
      background: none;
      border: none;
      color: #555;
      cursor: pointer;
      letter-spacing: 0.06em;
      transition: all 0.15s;
    }

    .two-btn button.on { background: var(--accent); color: #000; }

    /* â”€â”€ Botones genÃ©ricos â”€â”€ */
    .btn {
      font-family: var(--font-pixel);
      font-size: clamp(0.37rem, 1.8vw, 0.53rem);
      letter-spacing: 0.05em;
      padding: 11px 20px;
      min-width: 148px;
      background: transparent;
      border: 2px solid var(--accent);
      color: var(--accent);
      border-radius: 2px;
      cursor: pointer;
      text-align: center;
      transition: all 0.15s;
    }

    .btn:hover              { background: var(--accent); color: #000; }
    .btn.sm                 { font-size: 0.34rem; padding: 8px 14px; min-width: 110px; }
    .btn.danger             { border-color: var(--danger); color: var(--danger); }
    .btn.danger:hover       { background: var(--danger); color: #fff; }
    .btn.yellow             { border-color: var(--yellow); color: var(--yellow); }
    .btn.yellow:hover       { background: var(--yellow); color: #000; }

    /* â”€â”€ PuntuaciÃ³n final / pausa â”€â”€ */
    .final-score {
      font-family: var(--font-pixel);
      font-size: clamp(0.42rem, 2vw, 0.6rem);
      color: var(--bright);
      text-align: center;
      line-height: 2.2;
    }

    /* â”€â”€ Input de nombre (ranking) â”€â”€ */
    .name-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      width: 100%;
    }

    .name-wrap p {
      font-family: var(--font-pixel);
      font-size: 0.4rem;
      color: var(--yellow);
      text-align: center;
      line-height: 2.2;
    }

    .name-input {
      font-family: var(--font-pixel);
      font-size: 0.52rem;
      padding: 10px 16px;
      width: 100%;
      max-width: 240px;
      background: #111;
      border: 2px solid var(--accent);
      color: var(--accent);
      border-radius: 2px;
      text-align: center;
      letter-spacing: 0.12em;
      outline: none;
    }

    /* â”€â”€ Tabla de ranking â”€â”€ */
    .ranking-wrap { width: 100%; max-width: 420px; }

    .ranking-title {
      font-family: var(--font-pixel);
      font-size: 0.4rem;
      color: var(--yellow);
      letter-spacing: 0.1em;
      text-align: center;
      margin-bottom: 10px;
    }

    .ranking-table {
      width: 100%;
      border-collapse: collapse;
    }

    .ranking-table th {
      font-family: var(--font-pixel);
      font-size: 0.3rem;
      color: #444;
      letter-spacing: 0.08em;
      padding: 5px 6px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    .ranking-table td {
      font-family: var(--font-pixel);
      font-size: 0.35rem;
      color: var(--text);
      padding: 6px;
      border-bottom: 1px solid #161620;
    }

    .ranking-table tr.gold   td { color: var(--yellow); }
    .ranking-table tr.silver td { color: #bbb; }
    .ranking-table tr.bronze td { color: #cd7f32; }

    .rank-num   { color: #444; min-width: 22px; }
    .no-scores  { font-family: var(--font-pixel); font-size: 0.35rem; color: #333; text-align: center; padding: 18px; }

    /* â”€â”€ Tabs de nivel (ranking) â”€â”€ */
    .level-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      justify-content: center;
      margin-bottom: 10px;
    }

    .level-tab {
      font-family: var(--font-pixel);
      font-size: 0.3rem;
      padding: 4px 8px;
      border: 1px solid var(--border);
      background: none;
      color: #444;
      border-radius: 2px;
      cursor: pointer;
      letter-spacing: 0.05em;
      transition: all 0.15s;
    }

    .level-tab.active { border-color: var(--yellow); color: var(--yellow); }

    /* â”€â”€ D-pad (tÃ¡ctil) â”€â”€ */
    .dpad {
      display: none;
      grid-template-areas:
        ".    up    ."
        "left .     right"
        ".    down  .";
      grid-template-columns: repeat(3, 52px);
      grid-template-rows:    repeat(3, 52px);
      gap: 5px;
      margin-top: 6px;
    }

    /* Solo visible en pantallas tÃ¡ctiles */
    @media (pointer: coarse) { .dpad { display: grid; } }

    .dpad-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 1.15rem;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      touch-action: none;
      -webkit-tap-highlight-color: transparent;
      transition: all 0.1s;
    }

    .dpad-btn:active { background: #1e1e2e; color: var(--accent); border-color: var(--accent); }

    .dpad-up    { grid-area: up; }
    .dpad-left  { grid-area: left; }
    .dpad-right { grid-area: right; }
    .dpad-down  { grid-area: down; }
  </style>
</head>
<body>
<div class="wrapper">

  <!-- â”€â”€ Header â”€â”€ -->
  <div class="header">
    <div class="header-title">
      ğŸ SnakeGame
      <span>by jaimefg1888</span>
    </div>
    <button class="btn-pause hidden" id="btnPause">â¸</button>
    <div class="header-stats">
      <div class="stat-row">
        <div class="stat">
          <span class="stat-label" data-i18n="score">PUNTOS</span>
          <span class="stat-value" id="scoreDisplay">0</span>
        </div>
        <div class="stat">
          <span class="stat-label" data-i18n="time">TIEMPO</span>
          <span class="stat-value" id="timeDisplay">0:00</span>
        </div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Tablero + Overlays â”€â”€ -->
  <div class="canvas-wrap">
    <canvas id="gameCanvas"></canvas>

    <!-- MenÃº principal -->
    <div class="overlay" id="startScreen">
      <div class="lang-row">
        <button class="lang-btn active" id="langES">ğŸ‡ªğŸ‡¸ ES</button>
        <button class="lang-btn" id="langEN">ğŸ‡¬ğŸ‡§ EN</button>
      </div>

      <div class="ov-title">ğŸ SNAKE</div>

      <div class="speed-selector">
        <span class="speed-label" data-i18n="speed_lbl">VELOCIDAD</span>
        <div class="speed-boxes" id="speedBoxes"></div>
      </div>

      <div class="option-row">
        <span class="opt-label" data-i18n="walls_lbl">BORDES</span>
        <div class="two-btn">
          <button id="wallsOn"  class="on" data-i18n="yes">SÃ</button>
          <button id="wallsOff" data-i18n="no">NO</button>
        </div>
      </div>

      <button class="btn" id="startBtn" data-i18n="start">â–¶ COMENZAR</button>
      <button class="btn yellow sm" id="rankingBtn" data-i18n="ranking_btn">ğŸ† RANKING</button>
    </div>

    <!-- Pausa -->
    <div class="overlay hidden" id="pauseScreen">
      <div class="ov-title yellow" data-i18n="paused">â¸ PAUSA</div>
      <div class="final-score" id="pauseInfo"></div>
      <button class="btn" id="resumeBtn" data-i18n="resume">â–¶ CONTINUAR</button>
      <button class="btn sm" id="menuFromPauseBtn" data-i18n="main_menu">MENÃš PRINCIPAL</button>
    </div>

    <!-- Guardar nombre (top 10) -->
    <div class="overlay hidden" id="nameScreen">
      <div class="ov-title yellow" data-i18n="top10_title">ğŸ† TOP 10</div>
      <div class="name-wrap">
        <p data-i18n="name_prompt">Â¡Entraste al ranking!<br>Introduce tu nombre:</p>
        <input class="name-input" id="nameInput" maxlength="12" placeholder="NOMBRE" autocomplete="off" spellcheck="false" />
        <button class="btn" id="saveNameBtn" data-i18n="save">ğŸ’¾ GUARDAR</button>
      </div>
    </div>

    <!-- Game Over -->
    <div class="overlay hidden" id="gameOverScreen">
      <div class="ov-title danger" data-i18n="game_over">GAME OVER</div>
      <div class="final-score" id="finalScore"></div>
      <button class="btn" id="restartBtn" data-i18n="play_again">â–¶ JUGAR DE NUEVO</button>
      <button class="btn sm" id="menuFromGameOverBtn" data-i18n="main_menu">MENÃš PRINCIPAL</button>
      <button class="btn yellow sm" id="rankingFromGameOverBtn" data-i18n="ranking_btn">ğŸ† RANKING</button>
    </div>

    <!-- Ranking -->
    <div class="overlay hidden" id="rankingScreen">
      <div class="ov-title yellow" data-i18n="ranking_title">ğŸ† RANKING</div>
      <div class="level-tabs" id="levelTabs"></div>
      <div class="ranking-wrap" id="rankingContent"></div>
      <button class="btn sm" id="closeRankingBtn" data-i18n="close">âœ• CERRAR</button>
    </div>
  </div>

  <!-- D-pad (solo en tÃ¡ctil) -->
  <div class="dpad">
    <button class="dpad-btn dpad-up"    data-dir="UP">â–²</button>
    <button class="dpad-btn dpad-left"  data-dir="LEFT">â—€</button>
    <button class="dpad-btn dpad-right" data-dir="RIGHT">â–¶</button>
    <button class="dpad-btn dpad-down"  data-dir="DOWN">â–¼</button>
  </div>

</div><!-- /wrapper -->

<script>
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // INTERNACIONALIZACIÃ“N
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const LANGS = {
    es: {
      score: 'PUNTOS',  time: 'TIEMPO',   speed_lbl: 'VELOCIDAD', walls_lbl: 'BORDES',
      yes: 'SÃ',        no: 'NO',         start: 'â–¶ COMENZAR',    ranking_btn: 'ğŸ† RANKING',
      ranking_title: 'ğŸ† RANKING',        paused: 'â¸ PAUSA',      resume: 'â–¶ CONTINUAR',
      main_menu: 'MENÃš PRINCIPAL',        game_over: 'GAME OVER', play_again: 'â–¶ JUGAR DE NUEVO',
      close: 'âœ• CERRAR',                  top10_title: 'ğŸ† TOP 10',
      name_prompt: 'Â¡Entraste al ranking!\nIntroduce tu nombre:',
      save: 'ğŸ’¾ GUARDAR',   level: 'NIVEL',  player: 'JUGADOR',
      score_col: 'PTS',     date_col: 'FECHA',  no_scores: 'Sin puntuaciones aÃºn.',
      score_label: 'PUNTOS', time_label: 'TIEMPO', name_placeholder: 'NOMBRE',
    },
    en: {
      score: 'SCORE',   time: 'TIME',     speed_lbl: 'SPEED',     walls_lbl: 'WALLS',
      yes: 'YES',       no: 'NO',         start: 'â–¶ START',       ranking_btn: 'ğŸ† RANKING',
      ranking_title: 'ğŸ† RANKING',        paused: 'â¸ PAUSED',     resume: 'â–¶ RESUME',
      main_menu: 'MAIN MENU',             game_over: 'GAME OVER', play_again: 'â–¶ PLAY AGAIN',
      close: 'âœ• CLOSE',                   top10_title: 'ğŸ† TOP 10',
      name_prompt: "You made the ranking!\nEnter your name:",
      save: 'ğŸ’¾ SAVE',      level: 'LEVEL',  player: 'PLAYER',
      score_col: 'PTS',     date_col: 'DATE',   no_scores: 'No scores yet.',
      score_label: 'SCORE', time_label: 'TIME', name_placeholder: 'NAME',
    },
  };

  let lang = 'es';
  const t = key => LANGS[lang][key] || key;

  function applyLang() {
    document.querySelectorAll('[data-i18n]').forEach(el => {
      el.textContent = t(el.dataset.i18n);
    });
    document.getElementById('nameInput').placeholder = t('name_placeholder');
    document.getElementById('langES').classList.toggle('active', lang === 'es');
    document.getElementById('langEN').classList.toggle('active', lang === 'en');
    document.getElementById('wallsOn').textContent  = t('yes');
    document.getElementById('wallsOff').textContent = t('no');
    updateSpeedBoxes();
    if (rankingOpen) renderRanking(rankingLevel);
  }

  document.getElementById('langES').addEventListener('click', () => { lang = 'es'; applyLang(); });
  document.getElementById('langEN').addEventListener('click', () => { lang = 'en'; applyLang(); });


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CANVAS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const canvas = document.getElementById('gameCanvas');
  const ctx    = canvas.getContext('2d');
  const GRID   = 20;
  let CELL;

  function resizeCanvas() {
    const size  = canvas.parentElement.clientWidth;
    canvas.width = canvas.height = size;
    CELL = Math.floor(size / GRID);
  }

  resizeCanvas();
  window.addEventListener('resize', () => { resizeCanvas(); if (!running) drawFrame(); });


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ESTADO DEL JUEGO
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  let snake, dir, nextDir, food;
  let score = 0, timer = 0, timerInterval, startTime;
  let running = false, paused = false, gameOver = false;
  let walls = true, speed = 5;

  // Datos temporales para guardar en ranking tras game over
  let pendingScore = 0, pendingTime = 0, pendingSpeed = 5;

  // Control de la pantalla de ranking
  let rankingOpen = false, rankingLevel = 5, rankingFromMenu = false;


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // RANKING (localStorage â€” JSON por nivel)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const rankingKey = lvl => `snakeRanking_lvl${lvl}`;

  function getRanking(lvl) {
    try { return JSON.parse(localStorage.getItem(rankingKey(lvl))) || []; }
    catch { return []; }
  }

  function saveRanking(lvl, data) {
    localStorage.setItem(rankingKey(lvl), JSON.stringify(data));
  }

  function isTop10(lvl, sc) {
    const ranking = getRanking(lvl);
    return ranking.length < 10 || sc > (ranking[9]?.score ?? -1);
  }

  function addScore(lvl, name, sc, tm) {
    const ranking = getRanking(lvl);
    ranking.push({
      name:  (name.trim().toUpperCase() || '???').slice(0, 12),
      score: sc,
      time:  tm,
      date:  new Date().toLocaleDateString(),
    });
    ranking.sort((a, b) => b.score - a.score || a.time - b.time);
    ranking.splice(10);
    saveRanking(lvl, ranking);
  }


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // SELECTOR DE VELOCIDAD
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function buildSpeedBoxes() {
    const container = document.getElementById('speedBoxes');
    container.innerHTML = '';
    for (let i = 1; i <= 10; i++) {
      const box = document.createElement('button');
      box.className = 'speed-box' + (i === speed ? ' active' : '');
      box.addEventListener('click', () => { speed = i; updateSpeedBoxes(); });
      container.appendChild(box);
    }
  }

  function updateSpeedBoxes() {
    document.querySelectorAll('.speed-box').forEach((b, i) => {
      b.classList.toggle('active', i + 1 === speed);
    });
  }

  buildSpeedBoxes();

  // Toggle bordes
  document.getElementById('wallsOn').addEventListener('click', () => {
    walls = true;
    document.getElementById('wallsOn').classList.add('on');
    document.getElementById('wallsOff').classList.remove('on');
    if (!running) drawFrame();
  });

  document.getElementById('wallsOff').addEventListener('click', () => {
    walls = false;
    document.getElementById('wallsOff').classList.add('on');
    document.getElementById('wallsOn').classList.remove('on');
    if (!running) drawFrame();
  });


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // LÃ“GICA DEL JUEGO
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // Milisegundos entre ticks segÃºn nivel (1 = lento, 10 = rÃ¡pido)
  const speedToMs = s => Math.round(540 / (s * 0.88 + 0.4));

  function initGame() {
    const mid = Math.floor(GRID / 2);
    snake   = [{ x: mid, y: mid }, { x: mid - 1, y: mid }, { x: mid - 2, y: mid }];
    dir     = { x: 1, y: 0 };
    nextDir = { x: 1, y: 0 };
    score   = 0;
    timer   = 0;
    gameOver = false;
    paused   = false;
    document.getElementById('scoreDisplay').textContent = '0';
    document.getElementById('timeDisplay').textContent  = '0:00';
    spawnFood();
    startTimer();
  }

  function spawnFood() {
    let pos;
    do {
      pos = { x: Math.floor(Math.random() * GRID), y: Math.floor(Math.random() * GRID) };
    } while (snake.some(s => s.x === pos.x && s.y === pos.y));
    food = pos;
  }

  function startTimer() {
    clearInterval(timerInterval);
    startTime = Date.now();
    timerInterval = setInterval(() => {
      if (!paused && running && !gameOver) {
        timer = Math.floor((Date.now() - startTime) / 1000);
        const m = Math.floor(timer / 60);
        const s = timer % 60;
        document.getElementById('timeDisplay').textContent = `${m}:${s.toString().padStart(2, '0')}`;
      }
    }, 500);
  }

  // Game loop
  let lastTick = 0, animFrame;

  function gameLoop(ts) {
    if (!running || paused || gameOver) return;
    animFrame = requestAnimationFrame(gameLoop);
    if (ts - lastTick < speedToMs(speed)) return;
    lastTick = ts;
    tick();
  }

  function tick() {
    dir = { ...nextDir };
    const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };

    if (walls) {
      if (head.x < 0 || head.x >= GRID || head.y < 0 || head.y >= GRID) { endGame(); return; }
    } else {
      head.x = (head.x + GRID) % GRID;
      head.y = (head.y + GRID) % GRID;
    }

    if (snake.some(s => s.x === head.x && s.y === head.y)) { endGame(); return; }

    snake.unshift(head);

    if (head.x === food.x && head.y === food.y) {
      score++;
      document.getElementById('scoreDisplay').textContent = score;
      spawnFood();
    } else {
      snake.pop();
    }

    drawFrame();
  }


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // RENDER
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function drawFrame() {
    ctx.fillStyle = '#0d0d0d';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    drawFood();
    drawSnake();
    drawBorder();
  }

  function drawBorder() {
    const W = canvas.width;
    const t = 3; // grosor en px

    if (walls) {
      // Borde rojo con glow â€” indica que tocar = muerte
      ctx.save();
      ctx.shadowColor = 'rgba(255, 51, 85, 0.8)';
      ctx.shadowBlur  = 16;
      ctx.strokeStyle = '#ff3355';
      ctx.lineWidth   = t;
      ctx.strokeRect(t / 2, t / 2, W - t, W - t);
      // Segunda pasada sin blur para trazo nÃ­tido encima del glow
      ctx.shadowBlur  = 0;
      ctx.globalAlpha = 0.6;
      ctx.strokeRect(t / 2, t / 2, W - t, W - t);
      ctx.restore();
    } else {
      // Borde muy sutil verde â€” sin lÃ­mites, el tablero es abierto
      ctx.save();
      ctx.strokeStyle = 'rgba(0, 255, 136, 0.12)';
      ctx.lineWidth   = 1;
      ctx.strokeRect(0.5, 0.5, W - 1, W - 1);
      ctx.restore();
    }
  }

  function drawFood() {
    const fx = food.x * CELL + CELL / 2;
    const fy = food.y * CELL + CELL / 2;
    const fr = CELL * 0.38;

    // Halo rojo
    const glow = ctx.createRadialGradient(fx, fy, 0, fx, fy, fr * 2.8);
    glow.addColorStop(0, 'rgba(255, 51, 85, 0.3)');
    glow.addColorStop(1, 'transparent');
    ctx.fillStyle = glow;
    ctx.beginPath();
    ctx.arc(fx, fy, fr * 2.8, 0, Math.PI * 2);
    ctx.fill();

    // CÃ­rculo principal
    ctx.fillStyle = '#ff3355';
    ctx.beginPath();
    ctx.arc(fx, fy, fr, 0, Math.PI * 2);
    ctx.fill();

    // Brillo
    ctx.fillStyle = 'rgba(255, 160, 160, 0.55)';
    ctx.beginPath();
    ctx.arc(fx - fr * 0.3, fy - fr * 0.3, fr * 0.3, 0, Math.PI * 2);
    ctx.fill();
  }

  function drawSnake() {
    snake.forEach((seg, i) => {
      const x      = seg.x * CELL;
      const y      = seg.y * CELL;
      const isHead = i === 0;
      const pad    = 1.5;

      if (isHead) {
        // Halo verde alrededor de la cabeza
        const glow = ctx.createRadialGradient(x + CELL / 2, y + CELL / 2, 0, x + CELL / 2, y + CELL / 2, CELL * 1.2);
        glow.addColorStop(0, 'rgba(0, 255, 136, 0.2)');
        glow.addColorStop(1, 'transparent');
        ctx.fillStyle = glow;
        ctx.fillRect(x - CELL * 0.5, y - CELL * 0.5, CELL * 2, CELL * 2);
        ctx.fillStyle = '#00ff88';
      } else {
        const alpha = Math.max(0.22, 1 - (i / snake.length) * 0.78);
        ctx.fillStyle = `rgba(0, ${Math.round(140 + 115 * alpha)}, ${Math.round(70 * alpha)}, ${alpha})`;
      }

      roundedRect(ctx, x + pad, y + pad, CELL - pad * 2, CELL - pad * 2, isHead ? 4 : 2);
      ctx.fill();

      if (isHead) drawEyes(x, y);
    });
  }

  function drawEyes(x, y) {
    const eyeSize = Math.max(1.5, CELL * 0.11);
    let e1x, e1y, e2x, e2y;

    if (dir.x !== 0) {
      e1x = x + CELL * 0.5 + dir.x * CELL * 0.22;  e1y = y + CELL * 0.3;
      e2x = e1x;                                     e2y = y + CELL * 0.7;
    } else {
      e1x = x + CELL * 0.3;  e1y = y + CELL * 0.5 + dir.y * CELL * 0.22;
      e2x = x + CELL * 0.7;  e2y = e1y;
    }

    // Pupilas
    ctx.fillStyle = '#001a0d';
    ctx.beginPath();
    ctx.arc(e1x, e1y, eyeSize, 0, Math.PI * 2);
    ctx.arc(e2x, e2y, eyeSize, 0, Math.PI * 2);
    ctx.fill();

    // Brillos
    ctx.fillStyle = 'rgba(255, 255, 255, 0.55)';
    ctx.beginPath();
    ctx.arc(e1x - eyeSize * 0.35, e1y - eyeSize * 0.35, eyeSize * 0.38, 0, Math.PI * 2);
    ctx.fill();
    ctx.beginPath();
    ctx.arc(e2x - eyeSize * 0.35, e2y - eyeSize * 0.35, eyeSize * 0.38, 0, Math.PI * 2);
    ctx.fill();
  }

  function roundedRect(c, x, y, w, h, r) {
    c.beginPath();
    c.moveTo(x + r, y);
    c.lineTo(x + w - r, y);  c.arcTo(x + w, y,     x + w, y + r,     r);
    c.lineTo(x + w, y + h - r);  c.arcTo(x + w, y + h, x + w - r, y + h, r);
    c.lineTo(x + r, y + h);  c.arcTo(x,     y + h, x,     y + h - r, r);
    c.lineTo(x, y + r);      c.arcTo(x,     y,     x + r, y,         r);
    c.closePath();
  }


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // GESTIÃ“N DE PANTALLAS
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const SCREENS = ['startScreen', 'pauseScreen', 'nameScreen', 'gameOverScreen', 'rankingScreen'];

  function showOnly(id) {
    SCREENS.forEach(s => {
      document.getElementById(s).classList.toggle('hidden', s !== id);
    });
    if (!id) SCREENS.forEach(s => document.getElementById(s).classList.add('hidden'));
  }

  function startGame() {
    showOnly(null);
    running = true;
    document.getElementById('btnPause').classList.remove('hidden');
    initGame();
    drawFrame();
    lastTick = 0;
    requestAnimationFrame(gameLoop);
  }

  function endGame() {
    running  = false;
    gameOver = true;
    clearInterval(timerInterval);
    cancelAnimationFrame(animFrame);
    document.getElementById('btnPause').classList.add('hidden');

    pendingScore = score;
    pendingTime  = timer;
    pendingSpeed = speed;

    const m = Math.floor(timer / 60);
    const s = timer % 60;
    document.getElementById('finalScore').textContent =
      `${t('score_label')}: ${score}   ${t('time_label')}: ${m}:${s.toString().padStart(2, '0')}`;

    if (isTop10(speed, score)) {
      showOnly('nameScreen');
      setTimeout(() => document.getElementById('nameInput').focus(), 120);
    } else {
      showOnly('gameOverScreen');
    }
  }

  function togglePause() {
    if (!running || gameOver) return;
    paused = !paused;

    if (paused) {
      cancelAnimationFrame(animFrame);
      const m = Math.floor(timer / 60);
      const s = timer % 60;
      document.getElementById('pauseInfo').textContent =
        `${t('score_label')}: ${score}   ${t('time_label')}: ${m}:${s.toString().padStart(2, '0')}`;
      showOnly('pauseScreen');
    } else {
      showOnly(null);
      lastTick = 0;
      requestAnimationFrame(gameLoop);
    }
  }

  function saveScore() {
    const name = document.getElementById('nameInput').value || '???';
    document.getElementById('nameInput').value = '';
    addScore(pendingSpeed, name, pendingScore, pendingTime);
    showOnly('gameOverScreen');
  }

  function goToMenu() {
    running  = false;
    paused   = false;
    gameOver = true;
    clearInterval(timerInterval);
    cancelAnimationFrame(animFrame);
    document.getElementById('btnPause').classList.add('hidden');
    showOnly('startScreen');
  }


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // RANKING (pantalla)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function openRanking(lvl, fromMenu = false) {
    rankingOpen     = true;
    rankingLevel    = lvl || speed;
    rankingFromMenu = fromMenu;
    buildLevelTabs();
    renderRanking(rankingLevel);
    showOnly('rankingScreen');
  }

  function buildLevelTabs() {
    const container = document.getElementById('levelTabs');
    container.innerHTML = '';
    for (let i = 1; i <= 10; i++) {
      const btn = document.createElement('button');
      btn.className   = 'level-tab' + (i === rankingLevel ? ' active' : '');
      btn.textContent = `${t('level')} ${i}`;
      btn.addEventListener('click', () => {
        rankingLevel = i;
        document.querySelectorAll('.level-tab').forEach((b, j) => b.classList.toggle('active', j + 1 === i));
        renderRanking(i);
      });
      container.appendChild(btn);
    }
  }

  function renderRanking(lvl) {
    const data = getRanking(lvl);
    const wrap = document.getElementById('rankingContent');
    let html   = `<div class="ranking-title">${t('level')} ${lvl}</div>`;

    if (!data.length) {
      html += `<div class="no-scores">${t('no_scores')}</div>`;
    } else {
      html += `<table class="ranking-table">
        <tr><th>#</th><th>${t('player')}</th><th>${t('score_col')}</th><th>${t('date_col')}</th></tr>`;
      data.forEach((entry, i) => {
        const cls   = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
        const medal = i === 0 ? 'ğŸ¥‡'  : i === 1 ? 'ğŸ¥ˆ'     : i === 2 ? 'ğŸ¥‰'     : i + 1;
        html += `<tr class="${cls}">
          <td class="rank-num">${medal}</td>
          <td>${entry.name}</td>
          <td>${entry.score}</td>
          <td>${entry.date || '-'}</td>
        </tr>`;
      });
      html += '</table>';
    }

    wrap.innerHTML = html;
  }


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // EVENTOS DE BOTONES
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  document.getElementById('startBtn').addEventListener('click', startGame);
  document.getElementById('btnPause').addEventListener('click', togglePause);
  document.getElementById('resumeBtn').addEventListener('click', togglePause);
  document.getElementById('menuFromPauseBtn').addEventListener('click', goToMenu);
  document.getElementById('restartBtn').addEventListener('click', startGame);
  document.getElementById('menuFromGameOverBtn').addEventListener('click', () => showOnly('startScreen'));
  document.getElementById('saveNameBtn').addEventListener('click', saveScore);
  document.getElementById('nameInput').addEventListener('keydown', e => { if (e.key === 'Enter') saveScore(); });
  document.getElementById('rankingBtn').addEventListener('click', () => openRanking(speed, true));
  document.getElementById('rankingFromGameOverBtn').addEventListener('click', () => openRanking(pendingSpeed, false));
  document.getElementById('closeRankingBtn').addEventListener('click', () => {
    rankingOpen = false;
    if (rankingFromMenu)  showOnly('startScreen');
    else if (gameOver)    showOnly('gameOverScreen');
    else                  showOnly(null);
  });


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CONTROLES
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function changeDir(d) {
    if (!running || paused || gameOver) return;
    // Comparamos contra nextDir (no dir) para evitar que dos pulsaciones
    // rÃ¡pidas entre ticks introduzcan la direcciÃ³n contraria al giro encolado
    if (d.x !== -nextDir.x || d.y !== -nextDir.y) nextDir = d;
  }

  // Teclado
  const KEY_MAP = {
    ArrowUp:    { x: 0, y: -1 }, w: { x: 0, y: -1 }, W: { x: 0, y: -1 },
    ArrowDown:  { x: 0, y:  1 }, s: { x: 0, y:  1 }, S: { x: 0, y:  1 },
    ArrowLeft:  { x: -1, y: 0 }, a: { x: -1, y: 0 }, A: { x: -1, y: 0 },
    ArrowRight: { x:  1, y: 0 }, d: { x:  1, y: 0 }, D: { x:  1, y: 0 },
  };

  document.addEventListener('keydown', e => {
    if (e.key === ' ') { e.preventDefault(); togglePause(); return; }
    const d = KEY_MAP[e.key];
    if (d) { changeDir(d); e.preventDefault(); }
  });

  // D-pad
  const DPAD_MAP = { UP: { x: 0, y: -1 }, DOWN: { x: 0, y: 1 }, LEFT: { x: -1, y: 0 }, RIGHT: { x: 1, y: 0 } };

  document.querySelectorAll('.dpad-btn').forEach(btn => {
    btn.addEventListener('touchstart', e => {
      e.preventDefault();
      e.stopPropagation(); // evita que el swipe global capture este toque
      changeDir(DPAD_MAP[btn.dataset.dir]);
    }, { passive: false });
    btn.addEventListener('touchend', e => {
      e.stopPropagation(); // evita que touchend global calcule un swipe falso
    }, { passive: true });
    // click: compatibilidad con ratÃ³n / teclado de accesibilidad
    btn.addEventListener('click', () => changeDir(DPAD_MAP[btn.dataset.dir]));
  });

  // Swipe sobre el canvas (solo si el toque no viene del D-pad)
  let touchStartX = 0, touchStartY = 0;

  document.body.addEventListener('touchmove', e => {
    if (running && !paused) e.preventDefault();
  }, { passive: false });

  document.addEventListener('touchstart', e => {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
  }, { passive: true });

  document.addEventListener('touchend', e => {
    const dx = e.changedTouches[0].clientX - touchStartX;
    const dy = e.changedTouches[0].clientY - touchStartY;
    if (Math.abs(dx) < 15 && Math.abs(dy) < 15) return;
    const d = Math.abs(dx) > Math.abs(dy)
      ? (dx > 0 ? { x: 1, y: 0 } : { x: -1, y: 0 })
      : (dy > 0 ? { x: 0, y: 1 } : { x: 0, y: -1 });
    changeDir(d);
  }, { passive: true });


  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // INIT
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  resizeCanvas();
  drawFrame();
  applyLang();
</script>
</body>
</html>
